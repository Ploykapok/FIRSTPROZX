-- ================= SAVE CONFIG =================
local CONFIG_FILE = "KittyHub_Config.json"
local HttpService = game:GetService("HttpService")

local Config = {
    SelectedStat = "Strength",
    SelectedSpots = {
        Strength = nil,
        Durability = nil,
        Chakra = nil,
        Sword = nil,
        Agility = nil,
        Speed = nil
    },
    YOffset = 0,
    AutoFarm = false,
    AutoChikara = false,
    AntiAFK = false,
    TrainOnly = {
        Strength = false,
        Durability = false,
        Chakra = false,
        Sword = false,
        Agility = false,
        Speed = false
    }
}

-- โหลดค่า
if isfile(CONFIG_FILE) then
    local data = readfile(CONFIG_FILE)
    local decoded = HttpService:JSONDecode(data)
    if decoded then
        Config = decoded
    end
end

-- เซฟค่า
local function SaveConfig()
    writefile(CONFIG_FILE, HttpService:JSONEncode(Config))
end

-- ================= SERVICES =================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local Remotes = ReplicatedStorage:WaitForChild("Remotes")
local TrainRemote = Remotes:WaitForChild("RemoteEvent")

-- ================= STATE =================
local selectedStat = Config.SelectedStat or "Strength"
local autoFarm = Config.AutoFarm or false
local teleportYOffset = Config.YOffset or 0
local autoChikaraBox = Config.AutoChikara or false
local chikaraCooldown = 5
local lastChikaraClick = 0
local chikaraLock = false
local chikaraClickDelay = 0.5
local antiAFK = Config.AntiAFK or false

local trainOnlyStats = Config.TrainOnly or {
    Strength = false,
    Durability = false,
    Chakra = false,
    Sword = false,
    Agility = false,
    Speed = false
}

local selectedSpots = Config.SelectedSpots or {
    Strength = nil,
    Durability = nil,
    Chakra = nil,
    Sword = nil,
    Agility = nil,
    Speed = nil
}

local STAT_ID = {
    Strength = 1,
    Durability = 2,
    Chakra = 3,
    Sword = 4,
    Agility = 5,
    Speed = 6
}

-- ================= CHARACTER =================
local function getHRP()
    local char = player.Character or player.CharacterAdded:Wait()
    return char:WaitForChild("HumanoidRootPart")
end

local VirtualUser = game:GetService("VirtualUser")
player.Idled:Connect(function()
    if antiAFK then
        VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
        task.wait(0.1)
        VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    end
end)

-- ================= SMART TELEPORT =================
local function teleportSmart(target)
    if not target then return end
    local hrp = getHRP()
    local targetCF
    if target:IsA("Model") then
        targetCF = target:GetPivot()
    elseif target:IsA("BasePart") then
        targetCF = target.CFrame
    else
        return
    end
    local startPos = hrp.Position
    local goalPos = targetCF.Position
    local distance = (goalPos - startPos).Magnitude
    local STEP = 300
    local direction = (goalPos - startPos).Unit
    local steps = math.ceil(distance / STEP)
    for i = 1, steps do
        local pos = startPos + direction * math.min(i * STEP, distance)
        hrp.CFrame = CFrame.new(pos)
        RunService.Heartbeat:Wait()
    end
    hrp.CFrame = targetCF + Vector3.new(0, teleportYOffset, 0)
end

-- ================= TRAINING TELEPORT =================
local function teleportTo(spotName)
    local target = workspace.Map.TrainingAreas:FindFirstChild(spotName)
    if target then teleportSmart(target) end
end

-- ================= QUEST TELEPORT =================
local function teleportToQuest(questName)
    local npcFolder = workspace:WaitForChild("Scriptable"):WaitForChild("NPC"):WaitForChild("Quest")
    local target = npcFolder:FindFirstChild(questName)
    if target then teleportSmart(target) end
end

local function teleportAndClickChikaraBox()
    if chikaraLock then return end
    local now = os.clock()
    if now - lastChikaraClick < chikaraCooldown then return end
    chikaraLock = true
    lastChikaraClick = now
    local hrp = getHRP()
    local crate = workspace.Scriptable.ChikaraBoxes:FindFirstChild("ChikaraCrate")
    if not crate then chikaraLock = false return end
    local cf = crate:IsA("Model") and crate:GetPivot() or crate.CFrame
    hrp.CFrame = cf + Vector3.new(0, teleportYOffset, 0)
    task.wait(chikaraClickDelay)
    local clickBox = crate:FindFirstChild("ClickBox", true)
    if clickBox and clickBox:FindFirstChild("ClickDetector") then
        fireclickdetector(clickBox.ClickDetector)
    end
    task.delay(0.6, function() chikaraLock = false end)
end

-- ================= LOAD UI =================
local Library = loadstring(game:HttpGet(
    "https://raw.githubusercontent.com/x2zu/OPEN-SOURCE-UI-ROBLOX/refs/heads/main/X2ZU%20UI%20ROBLOX%20OPEN%20SOURCE/DummyUi-leak-by-x2zu/fetching-main/Tools/Framework.luau"
))()

local Window = Library:Window({
    Title = "Kitty Hub [AFS ENDLESS]",
    Desc = "Auto Farm [FREEMIER]",
    Icon = 105059922903197,
    Theme = "Dark",
    Config = { Keybind = Enum.KeyCode.LeftControl, Size = UDim2.new(0,450,0,350) },
    CloseUIButton = { Enabled = true, Text = "Close" }
})

-- ================= AUTO FARM TAB =================
local Tab = Window:Tab({Title = "Auto Farm", Icon = "star"})
Tab:Section({Title = "Auto Farm Stat"})

Tab:Dropdown({
    Title = "Select Stat",
    List = {"Strength","Durability","Chakra","Sword","Agility","Speed"},
    Value = selectedStat,
    Callback = function(v)
        selectedStat = v
        Config.SelectedStat = v
        SaveConfig()
    end
})

Tab:Toggle({Title = "Auto Farm", Value = autoFarm, Callback = function(v)
    autoFarm = v
    Config.AutoFarm = v
    SaveConfig()
end})

Tab:Section({Title = "Select Spot"})
local function CreateSpotDropdown(title, statList, statName)
    Tab:Dropdown({
        Title = title,
        List = statList,
        Value = selectedSpots[statName],
        Callback = function(v)
            selectedSpots[statName] = v
            Config.SelectedSpots[statName] = v
            SaveConfig()
        end
    })
end
CreateSpotDropdown("Strength Spots", {"Training Dummy","Fridge","Gym","Meteor","Lookout","Arena","Excalibur","FloatingIsland","Pig","Boulder","HeavenlyPillar"}, "Strength")
CreateSpotDropdown("Durability Spots", {"Pirate ship","Corp","Paw","BlackFire","Blackhole","Founder","King Kais","Time Chamber","Marine","IslandOfPower"}, "Durability")
CreateSpotDropdown("Chakra Spots", {"Tree1","Waterfall","Library","ToriiGate","Fox","PinkSwords","Sage","Ice","RamenShop","Ultimate Dragon","DoorBox","Eyeball","IceTree"}, "Chakra")
CreateSpotDropdown("Agility Spots", {"Trampoline","Gravity","KunaiGrounds","Church"}, "Agility")
CreateSpotDropdown("Speed Spots", {"Treadmills","Gravity","KunaiGrounds","Church"}, "Speed")

Tab:Section({Title = "Auto Farm Chikara"})
Tab:Toggle({Title = "Auto get Chikara Crate", Value = autoChikaraBox, Callback = function(v)
    autoChikaraBox = v
    Config.AutoChikara = v
    SaveConfig()
end})

-- ================= TRAIN ONLY TAB =================
local TTab = Window:Tab({Title = "Train Only", Icon = "zap"})
TTab:Section({Title = "Train only"})
for _, stat in ipairs({"Strength","Durability","Chakra","Sword","Agility","Speed"}) do
    TTab:Toggle({Title = stat, Value = trainOnlyStats[stat], Callback = function(v)
        trainOnlyStats[stat] = v
        Config.TrainOnly[stat] = v
        SaveConfig()
    end})
end

-- ================= QUEST TAB =================
local QTab = Window:Tab({Title = "Teleport", Icon = "map"})
QTab:Section({Title = "Quest"})
for _, quest in ipairs({"Boom","Ghoul","Giovanni","Reindeer","Santa","Sword Master"}) do
    QTab:Button({Title = quest, Callback = function() teleportToQuest(quest) end})
end

-- ================= SETTING TAB =================
local STab = Window:Tab({Title = "Setting", Icon = "map"})
STab:Section({Title = "Setting Farm"})

STab:Slider({
    Title = "Y Offset",
    Desc = "ปรับความสูง/ต่ำ ตอนวาป",
    Min = -5,
    Max = 5,
    Default = teleportYOffset,
    Increment = 1,
    Callback = function(v)
        teleportYOffset = v
        Config.YOffset = v
        SaveConfig()
    end
})

STab:Toggle({Title = "Anti AFK", Desc = "กันโดนเตะออกจากเกม", Value = antiAFK, Callback = function(v)
    antiAFK = v
    Config.AntiAFK = v
    SaveConfig()
end})

-- ================= AUTO FARM LOOP =================
task.spawn(function()
    while task.wait() do
        if autoFarm and selectedStat then
            local statId = STAT_ID[selectedStat]
            if selectedStat == "Sword" then
                TrainRemote:FireServer("Train", statId)
            else
                local spot = selectedSpots[selectedStat]
                if spot then
                    teleportTo(spot)
                    TrainRemote:FireServer("Train", statId)
                end
            end
        end
    end
end)

task.spawn(function()
    while task.wait() do
        if autoChikaraBox then
            teleportAndClickChikaraBox()
        end
    end
end)

task.spawn(function()
    while task.wait(0.3) do
        for stat, enabled in pairs(trainOnlyStats) do
            if enabled then
                local statId = STAT_ID[stat]
                if statId then
                    TrainRemote:FireServer("Train", statId)
                end
            end
        end
    end
end)

-- ================= NOTIFY =================
Window:Notify({Title = "Loaded", Desc = "Smart Warp + Auto Farm พร้อมใช้งาน", Time = 4})
