pcall(function()
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Kitty Hub | AFS Enless",
        Text = "Loaded Successfully ✅",
        Duration = 5
    })
end)

-- ================= SAVE CONFIG =================
local CONFIG_FILE = "KittyHub_Config.json"
local HttpService = game:GetService("HttpService")

local Config = {
    SelectedStat = "Strength",
    SelectedSpots = {
        Strength = nil,
        Durability = nil,
        Chakra = nil,
        Sword = nil,
        Agility = nil,
        Speed = nil
    },
    AutoFarm = false,
    AutoChikara = false,
    AntiAFK = false,
    TrainOnly = {
        Strength = false,
        Durability = false,
        Chakra = false,
        Sword = false,
        Agility = false,
        Speed = false
    },
    SelectedMob = "Sarka [E]",
    AutoFarmMob = false
}

if isfile(CONFIG_FILE) then
    local data = readfile(CONFIG_FILE)
    local decoded = HttpService:JSONDecode(data)
    if decoded then
        Config = decoded
    end
end

local function SaveConfig()
    writefile(CONFIG_FILE, HttpService:JSONEncode(Config))
end

-- ================= SERVICES =================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer
local RunService = game:GetService("RunService")
local Remotes = ReplicatedStorage:WaitForChild("Remotes")
local TrainRemote = Remotes:WaitForChild("RemoteEvent")

-- ================= STATE =================
local selectedStat = Config.SelectedStat or "Strength"
local autoFarm = Config.AutoFarm or false
local autoChikaraBox = Config.AutoChikara or false
local antiAFK = Config.AntiAFK or false
local trainOnlyStats = Config.TrainOnly or {}
local selectedSpots = Config.SelectedSpots or {}
local selectedMob = Config.SelectedMob or "Sarka [E]"
local autoFarmMob = Config.AutoFarmMob or false

local STAT_ID = {
    Strength = 1, Durability = 2, Chakra = 3,
    Sword = 4, Agility = 5, Speed = 6
}

local MOB_ID = {
    ["Sarka [E]"] = 1, ["Gen [D]"] = 2, ["Igicho [C]"] = 3,
    ["Remgonuk [B]"] = 4, ["Booh [A]"] = 5, ["Saytamu [S]"] = 6,
    ["(Boss) Riru [SS]"] = 1001
}

-- ================= CHARACTER =================
local function getHRP()
    local char = player.Character or player.CharacterAdded:Wait()
    return char:WaitForChild("HumanoidRootPart")
end

-- ================= MOB UTILS =================
local function isMobAlive(mob)
    if not mob then return false end
    local hum = mob:FindFirstChildWhichIsA("Humanoid")
    return hum and hum.Health > 0
end

local function teleportToMob(mob)
    if mob then
        getHRP().CFrame = mob:GetPivot()
    end
end

-- ================= TELEPORT =================
local function teleportTo(target)
    if target and target:IsA("Model") then
        getHRP().CFrame = target:GetPivot()
    elseif target and target:IsA("BasePart") then
        getHRP().CFrame = target.CFrame
    end
end

local function teleportToTraining(spotName)
    local target = workspace.Map.TrainingAreas:FindFirstChild(spotName)
    if target then teleportTo(target) end
end

local function teleportToQuest(questName)
    local npcFolder = workspace:WaitForChild("Scriptable"):WaitForChild("NPC"):WaitForChild("Quest")
    local target = npcFolder:FindFirstChild(questName)
    if target then teleportTo(target) end
end

local chikaraLock = false
local chikaraCooldown = 5
local lastChikaraClick = 0
local chikaraClickDelay = 0.5

local function teleportAndClickChikaraBox()
    if chikaraLock then return end
    local now = os.clock()
    if now - lastChikaraClick < chikaraCooldown then return end
    chikaraLock = true
    lastChikaraClick = now
    local crate = workspace.Scriptable.ChikaraBoxes:FindFirstChild("ChikaraCrate")
    if crate then
        teleportTo(crate)
        task.wait(chikaraClickDelay)
        local clickBox = crate:FindFirstChild("ClickBox", true)
        if clickBox and clickBox:FindFirstChild("ClickDetector") then
            fireclickdetector(clickBox.ClickDetector)
        end
    end
    task.delay(0.6, function() chikaraLock = false end)
end

-- ================= UI =================
local Library = loadstring(game:HttpGet(
    "https://raw.githubusercontent.com/x2zu/OPEN-SOURCE-UI-ROBLOX/refs/heads/main/X2ZU%20UI%20ROBLOX%20OPEN%20SOURCE/DummyUi-leak-by-x2zu/fetching-main/Tools/Framework.luau"
))()

local Window = Library:Window({
    Title="Kitty Hub [AFS ENDLESS]",
    Desc="Auto Farm [FREEMIER]",
    Icon=105059922903197,
    Theme="Dark",
    Config={Keybind=Enum.KeyCode.LeftControl, Size=UDim2.new(0,450,0,350)},
    CloseUIButton={Enabled=true, Text="Close"}
})

-- ================= STATUS INFO TAB =================
local STab = Window:Tab({Title="Status Info", Icon="info"})
STab:Section({Title="Player Stats"})

local statLabels = {}

-- Mapping Stat IDs กับชื่อ
local STAT_NAMES = {
    ["1"] = "Strength",
    ["2"] = "Durability",
    ["3"] = "Chakra",
    ["4"] = "Sword",
    ["5"] = "Agility",
    ["6"] = "Speed"
}

for i = 1,6 do
    local statName = STAT_NAMES[tostring(i)]
    statLabels[i] = STab:Label({
        Title = statName .. ": 0",
        Color = Color3.fromRGB(255,255,255)
    })
end

-- อัปเดตค่า Stat แบบเรียลไทม์ (ปัดเป็นจำนวนเต็ม)
local Players = game:GetService("Players")
local player = Players.LocalPlayer

task.spawn(function()
    while task.wait(0.5) do
        if player:FindFirstChild("Stats") then
            for i = 1,6 do
                local stat = player.Stats:FindFirstChild(tostring(i))
                if stat then
                    local name = STAT_NAMES[tostring(i)]
                    statLabels[i]:SetTitle(name .. ": " .. tostring(math.floor(stat.Value)))
                end
            end
        end
    end
end)

-- ================= AUTO FARM TAB =================
local Tab = Window:Tab({Title="Auto Farm", Icon="star"})
Tab:Section({Title="Auto Farm Stat"})
Tab:Dropdown({
    Title="Select Stat",
    List={"Strength","Durability","Chakra","Sword","Agility","Speed"},
    Value=selectedStat,
    Callback=function(v)
        selectedStat=v
        Config.SelectedStat=v
        SaveConfig()
    end
})
Tab:Toggle({Title="Auto Farm", Value=autoFarm, Callback=function(v)
    autoFarm=v
    Config.AutoFarm=v
    SaveConfig()
end})

Tab:Section({Title="Select Spot"})
local function CreateSpotDropdown(title, list, statName)
    Tab:Dropdown({
        Title=title,
        List=list,
        Value=selectedSpots[statName],
        Callback=function(v)
            selectedSpots[statName]=v
            Config.SelectedSpots[statName]=v
            SaveConfig()
        end
    })
end
CreateSpotDropdown("Strength Spots", {"Training Dummy","Fridge","Gym","Meteor","Lookout","Arena","Excalibur","FloatingIsland","Pig","Boulder","HeavenlyPillar"},"Strength")
CreateSpotDropdown("Durability Spots", {"Pirate ship","Corp","Paw","BlackFire","Blackhole","Founder","King Kais","Time Chamber","Marine","IslandOfPower"},"Durability")
CreateSpotDropdown("Chakra Spots", {"Tree1","Waterfall","Library","ToriiGate","Fox","PinkSwords","Sage","Ice","RamenShop","Ultimate Dragon","DoorBox","Eyeball","IceTree"},"Chakra")
CreateSpotDropdown("Agility Spots", {"Trampoline","Gravity","KunaiGrounds","Church"},"Agility")
CreateSpotDropdown("Speed Spots", {"Treadmills","Gravity","KunaiGrounds","Church"},"Speed")

Tab:Section({Title="Auto Farm Chikara"})
Tab:Toggle({Title="Auto get Chikara Crate", Value=autoChikaraBox, Callback=function(v)
    autoChikaraBox=v
    Config.AutoChikara=v
    SaveConfig()
end})

-- ================= AUTO FARM MOB =================
local mobList = {
    ["Sarka [E]"] = 1,
    ["Gen [D]"] = 2,
    ["Igicho [C]"] = 3,
    ["Remgonuk [B]"] = 4,
    ["Booh [A]"] = 5,
    ["Saytamu [S]"] = 6,
    ["(Boss) Riru [SS]"] = 1001
}

local selectedMob = Config.SelectedMob or "Sarka [E]"
local autoFarmMob = Config.AutoFarmMob or false
local farmMode = "Selected" -- Selected / Around / All
local currentTarget = nil

-- เพิ่มใน Tab Auto Farm เดิม
Tab:Section({Title="Auto Farm Mob"})
Tab:Dropdown({
    Title = "Select Mob",
    List = {"Sarka [E]","Gen [D]","Igicho [C]","Remgonuk [B]","Booh [A]","Saytamu [S]","(Boss) Riru [SS]"},
    Value = selectedMob, -- โหลดค่าเดิมจาก Config
    Callback = function(v)
        selectedMob = v
        Config.SelectedMob = v -- บันทึกค่าลง Config
        SaveConfig()
        currentTarget = nil -- รีเซ็ตเป้าหมายเดิม
    end
})

Tab:Dropdown({
    Title = "Farm Mode",
    List = {"Selected","Around","All"},
    Value = farmMode,
    Callback = function(v)
        farmMode = v
        currentTarget = nil
    end
})

Tab:Toggle({
    Title = "Auto Farm Mob",
    Value = autoFarmMob,
    Callback = function(v)
        autoFarmMob = v
        if not v then currentTarget = nil end
    end
})

-- ================= AUTO FARM MOB LOOP =================
local function isMobAlive(mob)
    if not mob then return false end
    local humanoid = mob:FindFirstChildWhichIsA("Humanoid")
    if humanoid and humanoid.Health > 0 then
        return true
    end
    return false
end

local function teleportToMob(mob)
    local hrp = getHRP()
    if mob.PrimaryPart then
        hrp.CFrame = mob.PrimaryPart.CFrame + Vector3.new(0,0,0)
    else
        hrp.CFrame = mob:GetPivot() + Vector3.new(0,0,0)
    end
end

-- ================= AUTO FARM MOB LOOP (FIXED) =================
task.spawn(function()
    while task.wait() do
        if not autoFarmMob then
            currentTarget = nil
            continue
        end

        local hrp = getHRP()

        -- ถ้าเป้าหมายเดิมยังไม่ตาย ให้วาปซ้ำ
        if currentTarget and isMobAlive(currentTarget) then
            teleportToMob(currentTarget)
            continue
        end

        currentTarget = nil

        -- ========= MODE: SELECTED =========
        if farmMode == "Selected" and selectedMob then
            local mobId = tostring(MOB_ID[selectedMob])
            local nearest, minDist = nil, math.huge

            for _, mob in pairs(workspace.Scriptable.Mobs:GetChildren()) do
                if mob.Name == mobId and isMobAlive(mob) then
                    local dist = (mob:GetPivot().Position - hrp.Position).Magnitude
                    if dist < minDist then
                        minDist = dist
                        nearest = mob
                    end
                end
            end

            if nearest then
                currentTarget = nearest
                teleportToMob(nearest)
            end

        -- ========= MODE: AROUND =========
        elseif farmMode == "Around" then
            local nearest, minDist = nil, math.huge

            for _, mob in pairs(workspace.Scriptable.Mobs:GetChildren()) do
                if isMobAlive(mob) then
                    local dist = (mob:GetPivot().Position - hrp.Position).Magnitude
                    if dist < minDist then
                        minDist = dist
                        nearest = mob
                    end
                end
            end

            if nearest then
                currentTarget = nearest
                teleportToMob(nearest)
            end

        -- ========= MODE: ALL =========
        elseif farmMode == "All" then
            for _, mob in pairs(workspace.Scriptable.Mobs:GetChildren()) do
                if isMobAlive(mob) then
                    currentTarget = mob
                    teleportToMob(mob)
                    break
                end
            end
        end
    end
end)

-- ================= TRAIN ONLY TAB =================
local TTab = Window:Tab({Title="Train Only", Icon="zap"})
TTab:Section({Title="Train only"})
for _, stat in ipairs({"Strength","Durability","Chakra","Sword","Agility","Speed"}) do
    TTab:Toggle({
        Title=stat,
        Value=trainOnlyStats[stat],
        Callback=function(v)
            trainOnlyStats[stat]=v
            Config.TrainOnly[stat]=v
            SaveConfig()
        end
    })
end

-- ================= TELEPORT TAB =================
local TeleportTab = Window:Tab({Title="Teleport", Icon="map"})

-- Section Quest
TeleportTab:Section({Title="Quest"})
for _, quest in ipairs({"Boom","Ghoul","Giovanni","Reindeer","Santa","Sword Master"}) do
    TeleportTab:Button({
        Title=quest,
        Callback=function()
            teleportToQuest(quest)
        end
    })
end

-- Section Shop
TeleportTab:Section({Title="Shop"})

-- Champions Normal
TeleportTab:Button({
    Title="Champions Normal",
    Callback=function()
        local shop = workspace:WaitForChild("Scriptable")
            :WaitForChild("NPC")
            :WaitForChild("Shops")
            :WaitForChild("Champions")
            :WaitForChild("1")

        if shop then
            local hrp = getHRP()
            -- ตรวจสอบว่า Model มี PrimaryPart
            if shop.PrimaryPart then
                hrp.CFrame = shop.PrimaryPart.CFrame + Vector3.new(0,6,0)
            else
                -- ถ้าไม่มี PrimaryPart ใช้ Pivot
                hrp.CFrame = shop:GetPivot() + Vector3.new(0,6,0)
            end
        end
    end
})

TeleportTab:Button({
    Title="Champions Lucky",
    Callback=function()
        local shop = workspace:WaitForChild("Scriptable")
            :WaitForChild("NPC")
            :WaitForChild("Shops")
            :WaitForChild("Champions")
            :WaitForChild("2")

        if shop then
            local hrp = getHRP()
            -- ตรวจสอบว่า Model มี PrimaryPart
            if shop.PrimaryPart then
                hrp.CFrame = shop.PrimaryPart.CFrame + Vector3.new(0,6,0)
            else
                -- ถ้าไม่มี PrimaryPart ใช้ Pivot
                hrp.CFrame = shop:GetPivot() + Vector3.new(0,6,0)
            end
        end
    end
})

-- Class
TeleportTab:Button({
    Title="Class Shop",
    Callback=function()
        local target = workspace:WaitForChild("Scriptable"):WaitForChild("NPC"):WaitForChild("Shops"):WaitForChild("FrameOpen"):WaitForChild("Classes")
        if target then teleportTo(target) end
    end
})

-- Special Shops
TeleportTab:Button({
    Title="Grimoires",
    Callback=function()
        local target = workspace:WaitForChild("Scriptable"):WaitForChild("NPC"):WaitForChild("Shops"):WaitForChild("Special"):WaitForChild("Grimoires"):WaitForChild("1")
        if target then teleportTo(target) end
    end
})

TeleportTab:Button({
    Title="Kagunes",
    Callback=function()
        local target = workspace:WaitForChild("Scriptable"):WaitForChild("NPC"):WaitForChild("Shops"):WaitForChild("Special"):WaitForChild("Kagunes"):WaitForChild("1")
        if target then teleportTo(target) end
    end
})

TeleportTab:Button({
    Title="Quirks",
    Callback=function()
        local target = workspace:WaitForChild("Scriptable"):WaitForChild("NPC"):WaitForChild("Shops"):WaitForChild("Special"):WaitForChild("Quirks"):WaitForChild("1")
        if target then teleportTo(target) end
    end
})

TeleportTab:Button({
    Title="Stands",
    Callback=function()
        local target = workspace:WaitForChild("Scriptable"):WaitForChild("NPC"):WaitForChild("Shops"):WaitForChild("Special"):WaitForChild("Stands"):WaitForChild("1")
        if target then teleportTo(target) end
    end
})
TeleportTab:Section({Title="Gacha"})
local gachaList = {
    ["Jutsu Levelling"] = "G1",
    ["Nen Levelling"] = "G2",
    ["Soul Levelling"] = "G3",
    ["Nichiyin Levelling"] = "G4",
    ["Seiyen Levelling"] = "G5",
    ["Hero Levelling"] = "G6"
}

for name, gachaId in pairs(gachaList) do
    TeleportTab:Button({
        Title = name,
        Callback = function()
            local npc = workspace:WaitForChild("Scriptable")
                :WaitForChild("NPC")
                :WaitForChild("Gacha")
                :WaitForChild(gachaId)
            if npc then
                local hrp = getHRP()
                if npc.PrimaryPart then
                    hrp.CFrame = npc.PrimaryPart.CFrame + Vector3.new(0,10,0)
                else
                    hrp.CFrame = npc:GetPivot() + Vector3.new(0,10,0)
                end
            end
        end
    })
end

-- ================= SETTING TAB =================
local STab = Window:Tab({Title="Setting", Icon="settings"})
STab:Section({Title="Settings"})
STab:Toggle({
    Title="Anti AFK",
    Desc="กันโดนเตะออกจากเกม",
    Value=antiAFK,
    Callback=function(v)
        antiAFK=v
        Config.AntiAFK=v
        SaveConfig()
    end
})

-- ================= AUTO FARM LOOP =================
task.spawn(function()
    while task.wait() do
        if autoFarm and selectedStat then
            local statId=STAT_ID[selectedStat]
            if selectedStat=="Sword" then
                TrainRemote:FireServer("Train", statId)
            else
                local spot=selectedSpots[selectedStat]
                if spot then
                    teleportToTraining(spot)
                    TrainRemote:FireServer("Train", statId)
                end
            end
        end
    end
end)

-- ================= AUTO CHIKARA LOOP =================
task.spawn(function()
    while task.wait(0.5) do
        if autoChikaraBox then
            teleportAndClickChikaraBox()
        end
    end
end)

-- ================= TRAIN ONLY LOOP =================
task.spawn(function()
    while task.wait(0.3) do
        for stat, enabled in pairs(trainOnlyStats) do
            if enabled then
                local statId=STAT_ID[stat]
                if statId then
                    TrainRemote:FireServer("Train", statId)
                end
            end
        end
    end
end)

-- ================= CUSTOM OFFSET FOR SAGE =================
local SAGE_OFFSET = Vector3.new(13,26,-5)

local oldTeleportToTraining = teleportToTraining
function teleportToTraining(spotName)
    local target = workspace.Map.TrainingAreas:FindFirstChild(spotName)
    if not target then return end

    if spotName == "Sage" then
        getHRP().CFrame = target:GetPivot() + SAGE_OFFSET
    else
        oldTeleportToTraining(spotName)
    end
end

-- ================= ANTI AFK LIGHT =================
player.Idled:Connect(function()
    if antiAFK then
        local cam = workspace.CurrentCamera.CFrame
        -- ขยับกล้องแค่เล็กน้อย
        workspace.CurrentCamera.CFrame = cam * CFrame.Angles(0, math.rad(0.1), 0)
    end
end)

-- ================= NOTIFY =================
Window:Notify({Title="Loaded", Desc="Kitty Hub | AFS ENLESS พร้อมใช้งาน✅ โง่!", Time=4})
